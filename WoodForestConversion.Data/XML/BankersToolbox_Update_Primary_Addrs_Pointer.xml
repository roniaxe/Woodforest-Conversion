<sqlinstruction>
<event server="#server_bankerstoolboxdb#" database="staging" timeout="36000">
<executesql>

-- insert into temp table minimum primary address pointer
select
	z_id
	,min(PRIMARY_ADDR_POINTER) as MIN_PRIMARY_ADDR_POINTER
into
	#MIN_PRIMARY_ADDR_POINTER
from
	[Bancline].[bankline_cif_name_info]
where
	PRIMARY_ADDR_POINTER is not null
group by
	z_id

-- update base table with minimum primary address pointer if null
update a
set
	PRIMARY_ADDR_POINTER = b.MIN_PRIMARY_ADDR_POINTER
from
	[Bancline].[bankline_cif_name_info] a
inner join
	#MIN_PRIMARY_ADDR_POINTER b on (a.Z_ID = b.Z_ID)
where
	a.PRIMARY_ADDR_POINTER is null

-- Get list of CIFs that have missing primary addr pointer
SELECT 
	 A.InstitutionID
	,A.Z_ID
	,A.PRIMARY_ADDR_POINTER
INTO
	#MissingRecords
FROM 
	[Staging].[Bancline].[bankline_cif_name_info] A
LEFT OUTER JOIN
	[Staging].[Bancline].[bankline_cif_addr_info] B ON (A.InstitutionID = B.InstitutionID and A.Z_ID = B.Z_ID AND A.PRIMARY_ADDR_POINTER = B.SEQ_ADD_VAL )
WHERE
	B.Z_ID IS NULL

-- blank out ALL PRIMARY_ADDR_POINTER since invalid
UPDATE #MissingRecords SET PRIMARY_ADDR_POINTER = NULL

-- get lowest SEQ_ADD_VAL from address table and update primary addr pointer
UPDATE A
SET
	PRIMARY_ADDR_POINTER = B.SEQ_ADD_VAL
FROM
	#MissingRecords A
INNER JOIN
	(
	SELECT	
		 B.InstitutionID
		,B.Z_ID
		,COUNT(*) AS [RECORDCOUNT]
		,MIN(B.SEQ_ADD_VAL) AS [SEQ_ADD_VAL]
	FROM
		#MissingRecords A
	INNER JOIN
		[Staging].[Bancline].[bankline_cif_addr_info] B ON (A.InstitutionID = B.InstitutionID AND A.Z_ID = B.Z_ID)
	WHERE
		B.SEQ_ADD_VAL IS NOT NULL
	GROUP BY
		 B.InstitutionID
		,B.Z_ID
	) B	ON (A.InstitutionID = B.InstitutionID AND A.Z_ID = B.Z_ID)

-- update primary table with missing primary address pointers
UPDATE A
SET
	PRIMARY_ADDR_POINTER = B.PRIMARY_ADDR_POINTER
FROM
	[Staging].[Bancline].[bankline_cif_name_info] A 
INNER JOIN
	#MissingRecords B ON (A.InstitutionID = B.InstitutionID AND A.Z_ID = B.Z_ID)
WHERE
	B.PRIMARY_ADDR_POINTER IS NOT NULL

</executesql> 
</event>
</sqlinstruction>