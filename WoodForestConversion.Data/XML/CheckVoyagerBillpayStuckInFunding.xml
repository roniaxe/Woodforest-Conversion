<?xml version="1.0" encoding="utf-8" ?>
<sqlinstruction>
	<event server="#server_voyagerdb#" database="WNBUtil" timeout="600">
<executesql>

DECLARE @date DATETIME, @FailureRate DECIMAL(20,6), @Threshold DECIMAL(20,6),@FailureMessage varchar(50)
SET @date = convert(VARCHAR, getdate(), 101)
SET @Threshold = 50

SELECT count(paymentid) AS StuckInFunding
	 , Datebeganprocessing INTO	#BillpayInFunding
FROM [Voyager].[dbo].[CCPaymentWorking]
WHERE DateFunded IS NULL AND DateBeganProcessing > @date
GROUP BY DateBeganProcessing

SELECT @FailureRate = StuckInFunding
FROM
	#BillpayInFunding
	
SELECT @FailureMessage = convert(VARCHAR, StuckInFunding) + ' Billpayments Stuck in Funding, Try recycling the web pool for dc1cviis02 dc1cviis03 and re-running the Billpay Job.'
FROM
	#BillpayInFunding

	IF @FailureRate > @Threshold
	BEGIN
		RAISERROR (@FailureMessage,16,2)
	END

DROP TABLE #BillpayInFunding

</executesql>
</event>
</sqlinstruction>

