<?xml version="1.0" encoding="utf-8" ?>
<sqlinstruction>
	<event server="#server_wnbappsdb#" database="OFC" timeout="600">
<executesql>
Declare @Date VARCHAR(20)
Declare @NSatSuccessful VARCHAR(100)
Declare @NSatFailed VARCHAR(100)
Declare @SatSuccessful VARCHAR(100)
Declare @SatFailed VARCHAR(100)
Declare @procdate DATETIME
Declare @datecurrent DATETIME
Declare @BusDay DATETIME

SELECT @Date = DATENAME(weekday, getdate())
SELECT @NSatSuccessful = COUNT(DISTINCT(UID)) FROM NotifyOptions (nolock) WHERE Status IN ('1','255') AND ENABLED = '1' AND WeeklyTranLog != '1'
SELECT @NSatFailed = COUNT(DISTINCT(UID)) FROM NotifyOptions (nolock) WHERE Status = '2' AND ENABLED = '1' AND WeeklyTranLog != '1'
SELECT @SatSuccessful = COUNT(DISTINCT(UID)) FROM NotifyOptions (nolock) WHERE Status IN ('1','255') AND ENABLED = '1'
SELECT @SatFailed = COUNT(DISTINCT(UID)) FROM NotifyOptions (nolock) WHERE Status = '2' AND ENABLED = '1'
SELECT @datecurrent = convert(datetime,convert(char,getdate(),102))
SELECT @Procdate = DATEADD(dd, -1, @datecurrent)

IF @Date != 'Saturday'
BEGIN
	INSERT INTO Notifications.dbo.Notify_SNTFLDEmail_Count ([Date],[Process Date],[Sent day],[Successful],[Failed])
	VALUES (@datecurrent,@Procdate,@Date,@NSatSuccessful,@NSatFailed)
END

ELSE
BEGIN
	INSERT INTO Notifications.dbo.Notify_SNTFLDEmail_Count ([Date],[Process Date],[Sent day],[Successful],[Failed])
	VALUES (@datecurrent,@Procdate,@Date,@SatSuccessful,@SatFailed)
END

</executesql>
</event>
	<event server="#server_wnbappsdb#" database="Notifications" timeout="600">
<executesql>
DECLARE @Date DATETIME
DECLARE @Successful VARCHAR(25)
DECLARE @Failed VARCHAR(25)
DECLARE @Message VARCHAR(300)


SELECT @Date = convert(datetime,convert(char,getdate(),102))
SELECT @Successful = [Successful] FROM dbo.Notify_SNTFLDEmail_Count WHERE [Date] = @Date
SELECT @Failed = [Failed] FROM dbo.Notify_SNTFLDEmail_Count WHERE [Date] = @Date
SELECT @Message = 'For the Date of ' + convert(varchar,@Date) + ' there were a total of ' + convert(varchar,@Successful) + ' notifications that successfully sent and a total of ' + convert(varchar,@Failed) + ' notifications that failed to send. If this total seems off verify all servers have completed.'


BEGIN
EXEC msdb.dbo.sp_send_dbmail
	@profile_name='WBCSQL01_Mail',
	@recipients='TechnologyOperations@woodforest.com',
	@subject='Notifications Sent and Failed totals',
	@body=@Message,
	@body_format='HTML';
END
</executesql>
</event>
</sqlinstruction>

